<style>
  .x-reset .x-column-header-inner .x-column-header-text {
    white-space: normal; !important;
  }

  .x-grid-checkheader {
    height: 14px;
    background-position: 50% -2px;
    background-repeat: no-repeat;
    background-color: transparent;
  }

  .x-grid-checkheader-checked {
    background-image: url('/extjs/src/ux/css/images/checked.gif');
  }

  .x-grid-checkheader-unchecked {
    background-image: url('/extjs/src/ux/css/images/unchecked.gif');
  }

  .x-grid-checkheader-editor .x-form-cb-wrap {
    text-align: center;
  }
</style>

<% @profiles = @profiles.find_all{ |profile| profile.id == 6074 } %>

<script>
  checkHandler = function(menuCheckItem, recordIndex, checked) {
    console.log('in checkHandler ' + menuCheckItem.dataIndex + ' ' + recordIndex + ' ' + checked);
  };

  var gridWidth = "100%";
  var columns = [
    { text: "Name", width: 200, sortable: true, dataIndex: "name" },
    { text: "Project", width: 180, sortable: true, dataIndex: "project" },
    <%- @prep_items.each do |prep_item| -%>
    { text: "<%= prep_item.title %>", flex: 1, dataIndex: "prep_item_<%= prep_item.id %>", xtype: 'checkcolumn', listeners: { checkchange: checkHandler } },
    <%- end -%>
  ]

  var fields = [
    {name: 'name'},
    {name: 'project'},
    <%- @prep_items.each do |prep_item| -%>
    { name: "prep_item_<%= prep_item.id %>", type: 'auto' },
    <%- end -%>
  ];

  var profileData = <%= @profiles.collect{ |profile| 
    [ "#{profile.class == StaffProfile ? "(staff) " : ""}#{profile.viewer.try(:name)}", profile.project.try(:name) ] + 
      @prep_items.collect{ |prep_item| @prep_item_applicable_profiles[prep_item].include?(profile) ? profile.received_prep_items.include?(prep_item) : nil }
  }.to_json %>;

</script>

<%= stylesheet_link_tag "/extjs/src/ux/css/LiveSearchGridPanel.css" %>
<%= javascript_include_tag "/main/received_paperwork/live-search-grid.js" %>

<br/>
<br/>

<center>
  <div id="grid-example"></div>
</center>

<p>Click checkboxes to mark paperwork items as received.</p>
<br/>

<%= sortable_table %>
  <thead><tr>
    <th>Name</th>  
    <th>Project</th>
    <% for prep_item in @prep_items %>
      <%= th prep_item.title, 'input' %>
    <% end %>
  </tr></thead>

  <tbody>
    
    <% for profile in @profiles %>
     <tr>
      <td><% if profile.class == StaffProfile %>(staff) <% end %><%= profile.viewer.try(:name) %></td>
      <td><%= profile.project.name %></td>
      <% for prep_item in @prep_items %>
        <% if @prep_item_applicable_profiles[prep_item].include?(profile) %>
          <td mochi:format='input'>
            <%- id = "prep_item_#{prep_item.id}_profile_id_#{profile.id}" -%>
            <%- received = profile.received_prep_items.include?(prep_item) -%>
            <%= check_box_tag id, "true", received, :id => id, :onClick =>
                remote_function(:url => {:controller => 'profile_prep_items', :action => 'set_received', :_method => "PUT", :format => 'js'},
                  :loading => "$('loading').show();",
                  :complete => "$('loading').hide();",
                  :with => "'prep_item_id=#{prep_item.id}&profile_id=#{profile.id}&received='+this.checked",
                  :method => :put
                )
             %>
          </td>
        <% else %>
          <td>&nbsp;</td>
        <% end %>
      <% end %>
     </tr>
    <% end %>

  </tbody>
</table>

<br />

<%= initialize_sortable_tables %>

<% if params[:from_tools]=="true" %>
  <a href="/tools/index">Back</a>
<% else %>
  <a href="/main/your_projects">Back</a>
<% end %>
